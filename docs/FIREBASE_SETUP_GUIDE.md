# Firebase Setup Guide - MyCancerCompanion

Complete step-by-step guide to set up Firebase for MyCancerCompanion app.

---

## Table of Contents
1. [Collections & Documents Structure](#1-collections--documents-structure)
2. [Firestore Indexes](#2-firestore-indexes)
3. [Security Rules](#3-security-rules)
4. [Initial Data Setup](#4-initial-data-setup)
5. [Testing Your Setup](#5-testing-your-setup)

---

## 1. Collections & Documents Structure

### Collection: `users`
**Purpose**: Store user profiles (HIPAA-compliant)

**Document ID**: User's Firebase Auth UID (e.g., `abc123xyz`)

**Structure**:
```javascript
{
  uid: "abc123xyz",
  firstName: "John",              // HIPAA: First name only
  email: "john@example.com",
  role: "patient",                // or "mentor"
  ageRange: "40-49",
  cancerType: "Lung Cancer",
  diagnosisStage: "Stage 2",
  treatmentType: "Chemotherapy, Radiation",
  recurrences: "No",
  supportNeeds: ["Peer Support", "Emotional Support"],
  hobbies: ["Reading", "Yoga", "Gardening"],
  bio: "Fighting strong since 2023!",
  profileComplete: true,
  createdAt: Timestamp(2026-01-09 15:00:00)
}
```

**Setup Steps**:
1. Go to Firebase Console → Firestore Database
2. Click "Start collection"
3. Collection ID: `users`
4. Add first document with your test user's UID
5. Add all fields as shown above

---

### Collection: `friendRequests`
**Purpose**: Manage connection requests between users

**Document ID**: Auto-generated by Firestore

**Structure**:
```javascript
{
  senderId: "abc123xyz",
  senderFirstName: "John",
  receiverId: "def456uvw",
  receiverFirstName: "Sarah",
  status: "pending",              // "pending" | "accepted" | "rejected"
  createdAt: Timestamp(2026-01-09 15:30:00),
  updatedAt: Timestamp(2026-01-09 15:30:00)
}
```

**Setup Steps**:
1. Click "Start collection"
2. Collection ID: `friendRequests`
3. Add a test document (auto-ID)
4. Add all fields as shown above

**Status Lifecycle**:
- `pending` → User A sent request to User B
- `accepted` → User B accepted (chat is created)
- `rejected` → User B rejected

---

### Collection: `chats`
**Purpose**: Store chat metadata between two users

**Document ID**: Composite key `{userId1}_{userId2}` (alphabetically sorted)
- Example: If user `abc123` chats with `xyz789`, ID is `abc123_xyz789`

**Structure**:
```javascript
{
  participants: ["abc123xyz", "def456uvw"],
  participantNames: {
    "abc123xyz": "John",
    "def456uvw": "Sarah"
  },
  lastMessage: {
    text: "How are you feeling today?",
    createdAt: Timestamp(2026-01-09 16:00:00),
    user: {
      _id: "abc123xyz",
      name: "John"
    }
  },
  lastMessageTime: Timestamp(2026-01-09 16:00:00),
  createdAt: Timestamp(2026-01-09 15:45:00)
}
```

**Setup Steps**:
1. Click "Start collection"
2. Collection ID: `chats`
3. **IMPORTANT**: Document ID must be `{userId1}_{userId2}` format
4. Add all fields as shown above

---

### Subcollection: `chats/{chatId}/messages`
**Purpose**: Store individual messages within a chat

**Path**: `chats/abc123_def456/messages/{messageId}`

**Document ID**: Auto-generated

**Structure**:
```javascript
{
  _id: "msg_001",
  text: "Thanks for your support!",
  createdAt: Timestamp(2026-01-09 16:00:00),
  user: {
    _id: "abc123xyz",
    name: "John"
  }
}
```

**Setup Steps**:
1. Navigate to a chat document (e.g., `chats/abc123_def456`)
2. Click "Start collection" (for subcollection)
3. Collection ID: `messages`
4. Add a test message with auto-ID
5. Add all fields as shown above

---

## 2. Firestore Indexes

Indexes are required for efficient queries. Create these in Firebase Console.

### How to Create Indexes:
1. Go to Firebase Console → Firestore Database → Indexes tab
2. Click "Create Index"
3. Enter the details below for each index

---

### Index 1: Friend Requests by Sender
**Collection**: `friendRequests`

| Field | Order/Array |
|-------|-------------|
| `senderId` | Ascending |
| `status` | Ascending |
| `createdAt` | Descending |

**Query Scope**: Collection

**Purpose**: Get all pending/accepted requests sent by a user

---

### Index 2: Friend Requests by Receiver
**Collection**: `friendRequests`

| Field | Order/Array |
|-------|-------------|
| `receiverId` | Ascending |
| `status` | Ascending |
| `createdAt` | Descending |

**Query Scope**: Collection

**Purpose**: Get all pending requests received by a user

---

### Index 3: Users by Role and Cancer Type
**Collection**: `users`

| Field | Order/Array |
|-------|-------------|
| `role` | Ascending |
| `cancerType` | Ascending |
| `createdAt` | Descending |

**Query Scope**: Collection

**Purpose**: Match patients with mentors by cancer type

---

### Index 4: Chats by Participant and Time
**Collection**: `chats`

| Field | Order/Array |
|-------|-------------|
| `participants` | Array-contains |
| `lastMessageTime` | Descending |

**Query Scope**: Collection

**Purpose**: Get all chats for a user, sorted by most recent

---

### Index 5: Messages by Time
**Collection Group**: `messages` (all subcollections)

| Field | Order/Array |
|-------|-------------|
| `createdAt` | Descending |

**Query Scope**: Collection group

**Purpose**: Get messages in a chat, sorted by time

**Special Setup**:
1. Go to Indexes tab
2. Click "Create Index"
3. **Select "Collection group" instead of "Collection"**
4. Collection group ID: `messages`
5. Add field as shown above

---

## 3. Security Rules

Replace your entire Firestore Security Rules with this:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function: Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function: Check if user owns the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // ========================================================================
    // USERS COLLECTION
    // ========================================================================
    match /users/{userId} {
      // Anyone authenticated can read user profiles (for matching)
      allow read: if isSignedIn();
      
      // Users can only create/update their own profile
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      
      // Users cannot delete their profile (prevent data loss)
      allow delete: if false;
    }
    
    // ========================================================================
    // FRIEND REQUESTS COLLECTION
    // ========================================================================
    match /friendRequests/{requestId} {
      // Users can read requests where they are sender or receiver
      allow read: if isSignedIn() && 
        (resource.data.senderId == request.auth.uid || 
         resource.data.receiverId == request.auth.uid);
      
      // Users can create requests where they are the sender
      allow create: if isSignedIn() && 
        request.resource.data.senderId == request.auth.uid &&
        request.resource.data.status == 'pending';
      
      // Only receiver can update (accept/reject)
      allow update: if isSignedIn() && 
        resource.data.receiverId == request.auth.uid &&
        request.resource.data.status in ['accepted', 'rejected'];
      
      // Sender can delete their own pending request (cancel)
      allow delete: if isSignedIn() && 
        resource.data.senderId == request.auth.uid &&
        resource.data.status == 'pending';
    }
    
    // ========================================================================
    // CHATS COLLECTION
    // ========================================================================
    match /chats/{chatId} {
      // Users can read/write chats where they are a participant
      allow read, write: if isSignedIn() && 
        request.auth.uid in resource.data.participants;
      
      // Users can create chats where they are a participant
      allow create: if isSignedIn() && 
        request.auth.uid in request.resource.data.participants;
      
      // ========================================================================
      // MESSAGES SUBCOLLECTION
      // ========================================================================
      match /messages/{messageId} {
        // Users can read messages if they're in the parent chat
        allow read: if isSignedIn() && 
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // Users can create messages if they're in the parent chat
        allow create: if isSignedIn() && 
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants &&
          request.resource.data.user._id == request.auth.uid;
        
        // Messages cannot be updated or deleted (preserve chat history)
        allow update, delete: if false;
      }
    }
  }
}
```

**How to Apply**:
1. Go to Firebase Console → Firestore Database → Rules tab
2. Replace all existing rules with the code above
3. Click "Publish"

---

## 4. Initial Data Setup

### Step 1: Create Test Users

Create 2-3 test user documents in the `users` collection:

**Patient Example** (Document ID: your Firebase Auth UID):
```javascript
{
  uid: "YOUR_AUTH_UID_HERE",
  firstName: "John",
  email: "john@test.com",
  role: "patient",
  ageRange: "40-49",
  cancerType: "Lung Cancer",
  diagnosisStage: "Stage 2",
  treatmentType: "Chemotherapy",
  recurrences: "No",
  supportNeeds: ["Peer Support", "Emotional Support"],
  hobbies: ["Reading", "Yoga"],
  bio: "Looking for support on my journey",
  profileComplete: true,
  createdAt: <Click "Add field" → Type: Timestamp → Click "Set to current time">
}
```

**Mentor Example** (Document ID: another test UID):
```javascript
{
  uid: "MENTOR_UID_HERE",
  firstName: "Sarah",
  email: "sarah@test.com",
  role: "mentor",
  ageRange: "50-59",
  cancerType: "Lung Cancer",
  diagnosisStage: "5 year survivor",
  treatmentType: "Chemotherapy, Radiation",
  recurrences: "No",
  supportNeeds: ["Hope/Inspiration"],
  hobbies: ["Gardening", "Cooking", "Walking"],
  bio: "5 years cancer-free! Here to help others",
  profileComplete: true,
  createdAt: <Timestamp - current time>
}
```

### Step 2: Test Friend Request Flow

1. **Create a friend request**:
   - Collection: `friendRequests`
   - Auto-generate ID
   ```javascript
   {
     senderId: "YOUR_PATIENT_UID",
     senderFirstName: "John",
     receiverId: "MENTOR_UID",
     receiverFirstName: "Sarah",
     status: "pending",
     createdAt: <Timestamp>,
     updatedAt: <Timestamp>
   }
   ```

2. **Accept the request** (update status):
   - Change `status` to `"accepted"`
   - Update `updatedAt` to current timestamp

3. **Create a chat** (after acceptance):
   - Collection: `chats`
   - Document ID: `{patientUid}_{mentorUid}` (alphabetically sorted)
   ```javascript
   {
     participants: ["PATIENT_UID", "MENTOR_UID"],
     participantNames: {
       "PATIENT_UID": "John",
       "MENTOR_UID": "Sarah"
     },
     lastMessage: null,
     lastMessageTime: <Timestamp>,
     createdAt: <Timestamp>
   }
   ```

### Step 3: Test Messaging

1. Navigate to the chat document you created
2. Create subcollection `messages`
3. Add a test message:
   ```javascript
   {
     _id: "msg_001",
     text: "Hi Sarah! Thanks for connecting with me.",
     createdAt: <Timestamp>,
     user: {
       _id: "PATIENT_UID",
       name: "John"
     }
   }
   ```

4. Update the parent chat's `lastMessage`:
   ```javascript
   lastMessage: {
     text: "Hi Sarah! Thanks for connecting with me.",
     createdAt: <Timestamp>,
     user: {
       _id: "PATIENT_UID",
       name: "John"
     }
   },
   lastMessageTime: <Timestamp>
   ```

---

## 5. Testing Your Setup

### Test Checklist

- [ ] **Users Collection**
  - [ ] Created at least 2 test users (1 patient, 1 mentor)
  - [ ] Both have same `cancerType` for matching
  - [ ] `profileComplete: true` on both

- [ ] **Friend Requests**
  - [ ] Created a test friend request
  - [ ] Status is "pending"
  - [ ] Can update status to "accepted"

- [ ] **Chats**
  - [ ] Created a chat with correct composite ID format
  - [ ] Both users are in `participants` array
  - [ ] `participantNames` map is correct

- [ ] **Messages**
  - [ ] Created messages subcollection
  - [ ] Added at least 1 test message
  - [ ] Updated parent chat's `lastMessage`

- [ ] **Indexes**
  - [ ] All 5 indexes created
  - [ ] Status shows "Enabled" (not "Building")

- [ ] **Security Rules**
  - [ ] Rules published successfully
  - [ ] No syntax errors

### Test in Your App

1. **Sign in** with your test account
2. **Complete onboarding** if needed
3. **Go to Peer Support tab**:
   - Should see the mentor you created
   - Connection status should show correctly
4. **Send a friend request**:
   - Click "Request Connection"
   - Check Firestore - should see new document in `friendRequests`
5. **Accept request** (manually in Firestore):
   - Update status to "accepted"
   - App should create chat automatically
6. **Send messages**:
   - Navigate to chat
   - Send a message
   - Check Firestore - should see in `messages` subcollection
   - Parent chat's `lastMessage` should update

---

## Common Issues & Solutions

### Issue: "Missing or insufficient permissions"
**Solution**: Check Security Rules are published correctly

### Issue: "Index required" error
**Solution**: 
1. Click the link in the error message
2. Firebase will auto-create the index
3. Wait 1-2 minutes for it to build

### Issue: Messages not showing in chat
**Solution**: 
1. Check messages are in correct subcollection path
2. Verify `createdAt` is a Timestamp (not string)
3. Check Security Rules allow read access

### Issue: Users not matching
**Solution**:
1. Verify both users have same `cancerType`
2. Check one is "patient" and other is "mentor"
3. Ensure `profileComplete: true` on both

---

## Quick Reference: Field Types

When creating documents in Firebase Console:

| Field | Type | Example |
|-------|------|---------|
| `uid`, `firstName`, `email`, `text` | string | `"John"` |
| `role`, `status` | string | `"patient"` |
| `participants`, `hobbies`, `supportNeeds` | array | `["item1", "item2"]` |
| `participantNames` | map | `{key: "value"}` |
| `profileComplete` | boolean | `true` |
| `createdAt`, `updatedAt`, `lastMessageTime` | timestamp | Click "Set to current time" |
| `lastMessage` | map | See chat structure above |

---

## Next Steps

After completing this setup:

1. ✅ Test all functionality in your app
2. ✅ Create more test users with different cancer types
3. ✅ Test the complete friend request → chat → messaging flow
4. ✅ Monitor Firestore usage in Firebase Console
5. ✅ Set up Firebase Authentication (if not already done)

---

## HIPAA Compliance Reminder

✅ **What we store**:
- First names only
- Age ranges (not exact ages)
- General cancer types
- Treatment types
- Diagnosis stages

❌ **What we DON'T store**:
- Last names
- Full dates of birth
- Addresses
- Phone numbers
- Social Security Numbers
- Medical record numbers
- Specific diagnosis dates
- Hospital/clinic names
- Profile photos

**Keep it this way!** Never add fields that could identify patients.
