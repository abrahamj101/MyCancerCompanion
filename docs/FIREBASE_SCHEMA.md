# Firebase Schema Documentation

This document outlines the Firestore database schema for MyCancerCompanion.

## Collections

### 1. `users`
Stores user profile information (HIPAA-compliant).

**Document ID**: User's Firebase Auth UID

**Fields**:
```typescript
{
  uid: string;                    // Firebase Auth UID
  firstName: string;              // HIPAA: First name only (no last name)
  email: string;                  // User's email
  role: 'patient' | 'mentor';     // User role
  ageRange: string;               // e.g., "30-40", "50-60"
  cancerType: string;             // e.g., "Breast Cancer", "Lung Cancer"
  diagnosisStage: string;         // e.g., "Stage 2", "5 year survivor"
  treatmentType: string;          // e.g., "Chemotherapy", "Radiation"
  recurrences: string;            // e.g., "None", "1", "2+"
  supportNeeds: string[];         // Array of support needs
  hobbies: string[];              // Array of hobbies/interests
  bio: string;                    // User bio/description
  profileComplete: boolean;       // Whether onboarding is complete
  createdAt: Timestamp;           // Account creation timestamp
}
```

**Indexes Required**:
- `role` (for querying mentors vs patients)
- `cancerType` (for matching algorithm)
- Composite: `role` + `cancerType` (for efficient mentor matching)

---

### 2. `friendRequests`
Stores friend/connection requests between users.

**Document ID**: Auto-generated by Firestore

**Fields**:
```typescript
{
  senderId: string;               // UID of user who sent request
  senderFirstName: string;        // HIPAA: First name only
  receiverId: string;             // UID of user who receives request
  receiverFirstName: string;      // HIPAA: First name only
  status: 'pending' | 'accepted' | 'rejected';
  createdAt: Timestamp;           // When request was created
  updatedAt: Timestamp;           // Last status update
}
```

**Indexes Required**:
- `senderId` + `status` (for querying sent requests)
- `receiverId` + `status` (for querying received requests)
- Composite: `senderId` + `receiverId` + `status` (for checking existing requests)

**Lifecycle**:
1. Created when user A sends request to user B (`status: 'pending'`)
2. Updated to `status: 'accepted'` when user B accepts (triggers chat creation)
3. Updated to `status: 'rejected'` when user B rejects
4. Can be deleted when user A cancels a pending request

---

### 3. `chats`
Stores chat metadata between two users.

**Document ID**: Composite key `{userId1}_{userId2}` (alphabetically sorted by UID)

**Fields**:
```typescript
{
  participants: string[];         // Array of 2 UIDs [uid1, uid2]
  participantNames: {             // Map of UID -> firstName
    [uid: string]: string;
  };
  lastMessage: {                  // Most recent message (for chat list preview)
    text: string;
    createdAt: Timestamp;
    user: {
      _id: string;                // Sender's UID
      name: string;               // HIPAA: First name only
    };
  } | null;
  lastMessageTime: Timestamp;     // For sorting chats by recency
  createdAt: Timestamp;           // When chat was created
}
```

**Indexes Required**:
- `participants` (array-contains for querying user's chats)
- `lastMessageTime` (for sorting chat list)
- Composite: `participants` + `lastMessageTime` (for efficient chat list queries)

**Example Document**:
```javascript
// Document ID: "abc123_xyz789"
{
  participants: ["abc123", "xyz789"],
  participantNames: {
    "abc123": "John",
    "xyz789": "Sarah"
  },
  lastMessage: {
    text: "How are you feeling today?",
    createdAt: Timestamp(2026-01-08 12:30:00),
    user: {
      _id: "abc123",
      name: "John"
    }
  },
  lastMessageTime: Timestamp(2026-01-08 12:30:00),
  createdAt: Timestamp(2026-01-07 10:00:00)
}
```

---

### 4. `chats/{chatId}/messages` (Subcollection)
Stores individual messages within a chat.

**Document ID**: Auto-generated by Firestore

**Fields**:
```typescript
{
  _id: string;                    // Message ID (for GiftedChat compatibility)
  text: string;                   // Message text content
  createdAt: Timestamp;           // When message was sent
  user: {
    _id: string;                  // Sender's UID
    name: string;                 // HIPAA: First name only
  };
}
```

**Indexes Required**:
- `createdAt` (for ordering messages chronologically)

**Example Document**:
```javascript
// Document path: chats/abc123_xyz789/messages/{messageId}
{
  _id: "msg_001",
  text: "Thanks for your support!",
  createdAt: Timestamp(2026-01-08 12:30:00),
  user: {
    _id: "abc123",
    name: "John"
  }
}
```

---

## Data Flow Examples

### Friend Request Flow
1. **User A sends request to User B**:
   - Create document in `friendRequests` with `status: 'pending'`
   - User A sees "Request Sent..." button
   - User B sees notification (future feature)

2. **User B accepts request**:
   - Update `friendRequests` document to `status: 'accepted'`
   - Create document in `chats` collection
   - Both users can now chat

3. **User B rejects request**:
   - Update `friendRequests` document to `status: 'rejected'`
   - No chat is created

### Messaging Flow
1. **User A sends message to User B**:
   - Add document to `chats/{chatId}/messages` subcollection
   - Update `chats/{chatId}` document's `lastMessage` and `lastMessageTime`

2. **User B receives message**:
   - Real-time listener on `chats/{chatId}/messages` triggers
   - Message appears in chat UI
   - Chat list updates with new preview

---

## Security Rules (Recommended)

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;
    }
    
    // Friend requests
    match /friendRequests/{requestId} {
      allow read: if request.auth != null && 
        (resource.data.senderId == request.auth.uid || 
         resource.data.receiverId == request.auth.uid);
      allow create: if request.auth != null && 
        request.resource.data.senderId == request.auth.uid;
      allow update: if request.auth != null && 
        resource.data.receiverId == request.auth.uid;
    }
    
    // Chats
    match /chats/{chatId} {
      allow read, write: if request.auth != null && 
        request.auth.uid in resource.data.participants;
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read: if request.auth != null && 
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        allow create: if request.auth != null && 
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      }
    }
  }
}
```

---

## HIPAA Compliance Notes

✅ **Compliant Practices**:
- Only storing first names (no last names)
- No profile photos/avatars
- No age (only age ranges)
- No specific location data
- No medical record numbers
- No diagnosis dates (only stages/survivor years)

❌ **Avoid Storing**:
- Last names
- Full dates of birth
- Specific addresses
- Phone numbers
- Social Security Numbers
- Medical record numbers
- Specific diagnosis dates
- Treatment facility names
